/* Copyright (c) 2011-2014 Thunderhead.com. All rights reserved. */
!function(){"use strict";window.Thunderhead=window.Thunderhead||{},window.Thunderhead.SF=window.Thunderhead.SF||{}}(),function(){"use strict";var e=window.Thunderhead.SF;_(e).extend({extend:function(e,t){return t||(t=e,e={}),e||(e={}),_(e).extend(t),e}});var t={on:function(e,t,n){return this._getEventListeners(e).push({callback:t,scope:n}),this},off:function(e,t){var n=t?function(e){return e.scope===t}:function(){return!0};return e?this._setEventListeners(e,_(this._getEventListeners(e)).reject(n)):_.chain(this._getListeners()).keys().each(_.bind(function(e){this._setEventListeners(e,_(this._getEventListeners(e)).reject(n))},this)),this},fire:function(e){var t=[];return t.push.apply(t,arguments),t.shift(),t.push(e),_(this._getEventListeners(e)).each(function(e){e.callback.apply(e.scope||this,t)}),this},_setEventListeners:function(e,t){this._getListeners[e]=t},_getEventListeners:function(e){var t=this._getListeners();return t[e]=t[e]||[],t[e]},_getListeners:function(){return this._ObservableListeners=this._ObservableListeners||{},this._ObservableListeners}};_(e).extend({mixinObservable:function(n){return e.extend(n,t)}})}(),function(){"use strict";function e(e,t,n){n||(n=t,t=[]),u[e]={moduleConstructor:n,dependencies:t},a.fire("defined",e,t)}function t(e){return e.replace(/\//g,"_").replace(/-(\w)/g,function(e){return e[1].toUpperCase()})}function n(e){var t=u[e],n=t.dependencies,i=t.moduleConstructor,r=$.Deferred();return d.apply(this,n).done(function(){var t=i.apply(this,arguments);c[e]=t,delete u[e],r.resolve(t)}),r.promise()}function i(e){var t=l[e];if(!t){var i=$.Deferred();a.fire("loading",e),s(e).done(function(){a.fire("loaded",e),n(e).done(function(t){a.fire("created",e),delete l[e],i.resolve(t)})}),t=l[e]=i.promise()}return t}function r(e){var n=e;e=t(n),a.fire("get",e,n);var r=$.Deferred(),o=c[e];return o?(a.fire("resolved",e),r.resolve(o)):i(e).done(function(t){a.fire("resolved",e),r.resolve(t)}),r.promise()}var o=window.Thunderhead.SF,s=function(){return $.Deferred().resolve().promise()},a={setModuleConstructorLoader:function(e){s=e}};o.mixinObservable(a);var d,c={},u={},l={};d=function(){var e=Array.prototype.slice.call(arguments),t=_(e).map(function(e){return r(e)});return t.push(Thunderhead.SF),t.push(window),$.when.apply($,t)},o.require=d,o.define=e,o.moduleRegistry=a}(),Thunderhead.SF.define("browser",function(e,t){"use strict";var n=t.document;return{getCookie:function(e){var t="; "+n.cookie,i=t.split("; "+e+"=");return 2===i.length?i.pop().split(";").shift():void 0},setCookie:function(e,t){n.cookie="apex__"+e+"="+t+";secure"},getUrlParams:function(){var e={};return t.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(t,n,i){e[n]=i}),e},urlEncode:function(e){return encodeURIComponent(e)},redirect:function(e){t.location.href=e},getHash:function(){var e=t.location.hash;return""!==e?e:void 0},setDraftIdHash:function(e){var n=t.location.href,i="#dr"+e;t.location.replace(n.replace(t.location.hash,"")+i)},setDocboxIdHash:function(e){var n=t.location.href,i="#db"+e;t.location.replace(n.replace(t.location.hash,"")+i)},getDraftIdHash:function(){var e=t.location.hash;return e.match("^#dr")?e.substr(e.indexOf("#dr")+3):void 0},getDocboxIdHash:function(){var e=t.location.hash;return e.match("^#db")?e.substr(e.indexOf("#db")+3):void 0}}}),Thunderhead.SF.define("features",function(){"use strict";return{}}),Thunderhead.SF.define("generalSettings",function(){"use strict";return{}}),Thunderhead.SF.define("messageBroker",function(e,t){"use strict";var n=t.Thunderhead;return n.SF.MessageBroker={_subscribers:[],_registeredWindows:[],registerWindow:function(e){this._registeredWindows.push(e)},registerWindows:function(e){this._registeredWindows=this._registeredWindows.concat(e)},subscribe:function(e,t,n){n=n||this,this._subscribers[e]||(this._subscribers[e]=[]),this._subscribers[e].push(function(){return t.apply(n,arguments)})},broadcast:function(e,t){var n,i;for(n=0,i=this._registeredWindows.length;i>n;n+=1)this._registeredWindows[n].Thunderhead&&this._registeredWindows[n].Thunderhead.SF&&this._registeredWindows[n].Thunderhead.SF.MessageBroker&&this._registeredWindows[n].Thunderhead.SF.MessageBroker.publish(e,t);this.publish(e,t)},publish:function(e,t){var n=this._subscribers;if(n&&n[e]){var i,r;for(i=0,r=n[e].length;r>i;i+=1)n[e][i](t)}}},n.SF.MessageBroker}),Thunderhead.SF.define("session",function(){"use strict";return{}}),Thunderhead.SF.define("thirdParty_jQuery",function(e,t){"use strict";if(!t.$)throw"Third Party Library Missing";return t.$}),Thunderhead.SF.define("documentUploadService",["thirdParty_jQuery","messageBroker"],function(e,t){"use strict";var n=function(t,n,i,r,o,s,a){var d="."+t,c="."+n,u="."+i,l="."+r,h=a;this.subscribe(h+"/upload",function(e){e.storageLocation?this.selectFile(e.description,e.storageLocation):this.throwError("uploadStarted","A storage location must be provided")},this),this.subscribe(h+"/deleteDoc",function(e){e.docId?this.deleteDocument(e.docId):this.throwError("deleted","A document id must be provided")},this),this.startUpload=function(t){var n=t.split("\\"),i=n[n.length-1];this.broadcast(h+"/uploadStarted",{event:{status:!0},params:{docName:i}}),e(c).click()},this.selectFile=function(){e(d).click()},this.deleteDocument=function(t){e(u).val(t),e(l).click()},this.finishUpload=function(e,t){this.broadcast(h+"/uploaded",{event:{status:!0},params:{docId:e,docName:t}})},this.acknowledgeDelete=function(e){this.broadcast(h+"/deleted",{event:{status:!0},params:{docId:e}})},this.throwError=function(e,t,n){this.broadcast(h+"/"+e,{event:{status:!1,message:t,details:n}})}};return n.prototype=t,n}),Thunderhead.SF.define("fileUploader",["thirdParty_jQuery","messageBroker"],function(e,t,n,i){"use strict";var r=function(t){var n,r=t.serviceId||"defaultService",o=t.fileObjectType||"document",s=t.iframeContainerId||"uploadContainer",a=t.storageLocation;if(!a)throw{name:"File Uploader Error",message:"Invalid argument: Storage Location",toString:function(){return this.name+": "+this.message}};n="apex/COMMON_UploadService?uploadObjType="+encodeURIComponent(o)+"&serviceId="+encodeURIComponent(r)+"&storageLocation="+encodeURIComponent(t.storageLocation)+"&description="+encodeURIComponent(t.fileDescription);var d='<iframe src="'+n+'" id="'+r+'" name="'+r+'" frameBorder="0" style="height: '+t.buttonHeight+";width: "+t.buttonWidth+'" /><input class="skywalker_button" id="'+r+'UploadingButton" disabled="disabled"type="button" style="display:none;" value="From My Computer" />';e("#"+s).append(d),this.registerWindow(i.frames[r]);var c=function(t){t.event.status===!0&&(e("#"+r).css("display","none"),e("#"+r+"UploadingButton").css("display","inline"))};this.subscribe(r+"/uploadStarted",c,this);var u=function(){e("#"+r).css("display","inline"),e("#"+r+"UploadingButton").css("display","none")};this.subscribe(r+"/uploaded",u,this),this.subscribe(r+"/deleted",u,this),this.registerFileSelectionCallback=function(e,t){this.subscribe(r+"/uploadStarted",e,t)},this.registerUploadedCallback=function(e,t){this.subscribe(r+"/uploaded",e,t)},this.registerFileDeletedCallback=function(e,t){this.subscribe(r+"/deleted",e,t)},t.fileSelectionCallback&&this.registerFileSelectionCallback(t.fileSelectionCallback,t.fileSelectionScope),t.fileUploadedCallback&&this.registerUploadedCallback(t.fileUploadedCallback,t.fileUploadedScope),t.deletedCallback&&this.registerFileDeletedCallback(t.deletedCallback,t.deletedScope),this.openFileUploadDialog=function(e,t){this.broadcast(r+"/upload",{description:e,storageLocation:t})},this.deleteFile=function(e){c({event:{status:!0}}),this.broadcast(r+"/deleteDoc",{docId:e})},this.cancelUpload=function(){u(),e("#"+r).attr("src",n)}};return r.prototype=t,r}),Thunderhead.SF.define("thirdParty_mustache",function(e,t){"use strict";if(!t.Mustache)throw"Third Party Library Missing";return t.Mustache}),Thunderhead.SF.define("thirdParty_underscore",function(e,t){"use strict";if(!t._)throw"Third Party Library Missing";return t._}),Thunderhead.SF.define("models",["thirdParty_underscore"],function(e,t){"use strict";var n,i={};n=i.Collection=function(e){return this instanceof n?void this.push.apply(this,e||[]):new n(e)},n.prototype=[],t.mixinObservable(n.prototype),e(["pop","push","reverse","shift","sort","splice","unshift"]).each(function(e){n.prototype[e]=function(){var t=Array.prototype[e].apply(this,arguments);return this.fire("change"),t}}),n.prototype.set=function(e){Array.prototype.splice.call(this,0,this.length),Array.prototype.push.apply(this,e),this.fire("change")},n.prototype.pushAll=function(e){this.push.apply(this,e)},e(["each","map","reduce","reduceRight","find","filter","reject"]).each(function(t){n.prototype[t]=n.prototype[t]||function(){var n=[this];return n.push.apply(n,arguments),e[t].apply(e,n)}}),n.prototype.rejectInplace=function(e){return this.set(this.reject(e)),this},n.prototype.filterInplace=function(e){return this.set(this.filter(e)),this};var r=function(){};return t.mixinObservable(r.prototype),r.prototype.get=function(e){return this._val[e]},r.prototype.set=function(e,t){var n=this._val[e];t!==n&&(this._val[e]=t,this.fire("set:"+e,t),this.fire("set",e,t))},r.prototype.val=function(){return e(this._val).clone()},i.extend=function(n){n=n||{};var i=n.defaults||{};e(i).isFunction()&&(i=i());var o=n.initializer||function(){},s=function(t){if(!(this instanceof s))return new s(t);var n=this;t=t||{},this._val={},e.chain(i).clone().extend(t).each(function(e,t){n.set(t,e)}),o.call(this)};return t.extend(s.prototype,new r),s},i.DTO=function(t,n,i,r){t._DTOBinding=e(n).clone(),t.fromDTO=function(n){var r=e(t._DTOBinding).reduce(function(t,i,r){var o=n[r];return e(o).isNull()||e(o).isUndefined()||(i===!0?t[r]=o:e(i).isString()?t[i]=o:i.fromDTO(t,o,r)),t},{});return i&&e(r).extend(i(n)),t(r)},t.prototype.toDTO=function(){var n=this,i=e(t._DTOBinding).reduce(function(t,i,r){var o;return o=i===!0?n.get(r):e(i).isString()?n.get(i):i.toDTO(n,r),e(o).isNull()||e(o).isUndefined()||(t[r]=o),t},{});return r&&e(i).extend(r.call(this)),i}},i}),Thunderhead.SF.define("docedt_documentModels",["models"],function(e){"use strict";var t,n={};return t=n.Document=e.extend(),e.DTO(t,{id:!0,name:!0,contentType:!0,storageLocation:"folderId"}),n}),Thunderhead.SF.define("docedt_emailModels",["thirdParty_underscore","models","docedt_documentModels"],function(e,t,n){"use strict";var i,r,o=t.Collection,s={};return i=s.Email=t.extend({defaults:function(){return{attachments:new o}}}),r=s.EmailAttachment=t.extend({defaults:{type:1,retainedReference:!1,isInaccessible:!1}}),i.prototype.getAttachment=function(e){return this.get("attachments")[e]},i.prototype.getAttachmentByDocumentName=function(t){return e(this.get("attachments")).find(function(e){return e.get("document").get("name")===t})},i.prototype.addAttachment=function(){var e=this.get("attachments");return e.push.apply(e,arguments)},i.prototype.removeAttachment=function(e){var t=this.get("attachments").indexOf(e);t>-1&&this.get("attachments").splice(t,1)},e(r).extend({SALESFORCE_DOCUMENT:1,LOCAL_ATTACHMENT:2,DRAFT_ATTACHMENT:3,OBJECT_ATTACHMENT:4,createDraftAttachment:function(e){return e.type=r.DRAFT_ATTACHMENT,new r(e)},createObjectAttachment:function(e){return e.type=r.OBJECT_ATTACHMENT,new r(e)}}),r.prototype.isSalesforceDocument=function(){return r.SALESFORCE_DOCUMENT===this.get("type")},t.DTO(i,{subject:!0,fromAddress:"from",toAddresses:"to",ccAddresses:"cc",bccAddresses:"bcc",toTargetObjectName:!0,toTargetObjectId:!0},function(t){var n=t.draftAttachments,i={};if(n){var s=[];e(n).each(function(e){s.push(r.fromDTO(e))}),i.attachments=new o(s)}return i},function(){var e=[];return this.get("attachments").each(function(t){e.push(t.toDTO())}),{draftAttachments:e}}),t.DTO(r,{attachmentRefId:"id",attachmentType:"type",retainedReference:!0,isInaccessible:!0},function(e){return{document:n.Document.fromDTO(e)}},function(){return this.get("document").toDTO()}),s}),Thunderhead.SF.define("thunderhead",function(e,t){"use strict";return t.Thunderhead}),Thunderhead.SF.define("ui_dropdown",["thirdParty_jQuery","thirdParty_mustache","generalSettings"],function(e,t,n){"use strict";return function(i,r,o,s){if(n.orgIsChatterEnabled){r.addClass("drop_down_area");var a=t.render(e("#dropdown-button_tmpl").html(),{id:i,buttonLabel:s,menuClass:o}),d=e(a);e("#"+i).replaceWith(d),d.click(function(){var t=d.position().left,n=d.position().top+25;r.css({position:"absolute",top:n+"px",left:t+"px"});var i=r.is(":visible");e(".drop_down_area:visible").each(function(t,n){e(n).hide()}),i||r.show()})}}}),Thunderhead.SF.define("ui_jobMessages",["thirdParty_jQuery","thirdParty_mustache"],function(e,t,n){"use strict";var i={_container:null,_hasErrors:!1,_tableTemplate:'<div class="bPageBlock brandSecondaryBrd apexDefaultPageBlock secondaryPalette"><div class="pbHeader"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="pbTitle">&nbsp;</td><td><input class="btn back-button" value="Back" type="button"/>{{#noErrors}}<input class="btn continue-button" value="Continue" type="button"/>{{/noErrors}}</td></tr></tbody></table></div><div class="pbBody"><div><table class="list" border="0" cellpadding="0" cellspacing="0" style="width:100%;"><thead class="rich-table-thead"><tr class="headerRow"><th class="headerRow">Type</th><th class="headerRow">Messages</th></tr></thead><tbody>{{#messages}}<tr class="row1"><td class="col_type" align="left" width="200px">{{MessageTypeLabel}}</td><td class="col_message">{{{MessageText}}}</td></tr>{{/messages}}</tbody></table></div></div><div class="pbBottomButtons"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="pbTitle">&nbsp;</td><td><input class="btn back-button" value="Back" type="button"/>{{#noErrors}}<input class="btn continue-button" value="Continue" type="button" />{{/noErrors}}</td></tr></tbody></table></div></div>',_getMessageType:function(e){var t;for(t=0;t<e.length;t+=1)e[t].MessageType===i._messageTypeInfo?e[t].MessageTypeLabel="Info":e[t].MessageType===i._messageTypeWarning?e[t].MessageTypeLabel="Warning":e[t].MessageType===i._messageTypeError&&(e[t].MessageTypeLabel="Error",this._hasErrors=!0);return e},continueProcess:function(){this.clearContainer(),this.fire("MESSAGES_CONTINUE")},back:function(){this.fire("MESSAGES_BACK")},clearContainer:function(){this._container.empty()},getMessageTable:function(n,i){n=this._getMessageType(n);var r={messages:n,noErrors:!this._hasErrors},o=t.render(this._tableTemplate,r);this._container=e(i),this._container.empty();var s=e(o).appendTo(i);return s.find(".back-button").click(e.proxy(this.back,this)),s.find(".continue-button").click(e.proxy(this.continueProcess,this)),s}};return n.extend(i,{_messageTypeInfo:"I",_messageTypeWarning:"W",_messageTypeError:"E"}),n.mixinObservable(i),i}),Thunderhead.SF.define("ui_messages",["thirdParty_mustache"],function(e){"use strict";return{_messageTmpl:null,buildWarningHtml:function(e,t){return this._getMessageHtml("WARNING",e,t)},buildErrorHtml:function(e){return this._getMessageHtml("ERROR",e)},buildErrorListHtml:function(e){return this._getMessageHtml("ERROR",void 0,e)},buildSuccessHtml:function(e){return'<img alt="saved" src="/img/msg_icons/confirm24.png">'+e},_getMessageHtml:function(t,n,i){var r,o,s=this._getMessageTmpl();"ERROR"===t?(o="color:#cc0000",r=n?"Error:":"Errors"):(o="",r=n?"Warning:":"Warnings");var a={levelM3:"ERROR"===t?"errorM3":"warningM3",level:t,messageTextStyle:o,messageLevel:r,message:void 0!==n?n:"",messages:i,hasMessages:i&&i.length>0};return e.render(s,a)},_getMessageTmpl:function(){return this._messageTmpl?this._messageTmpl:(this._messageTmpl='<div class="message {{levelM3}}" role="alert"><table border="0" cellpadding="0" cellspacing="0" class="messageTable" style="padding:0px;margin:0px;"><tbody><tr valign="top"><td><img alt="{{level}}" class="msgIcon" src="/s.gif" title="{{level}}"></td><td class="messageCell"><div class="messageText"><span style="{{messageTextStyle}}"><h4>{{messageLevel}}</h4></span>{{{message}}}<br></div></td></tr><tr><td></td><td>{{#hasMessages}}<span><ul style="padding-left:10px;padding-top:0px;margin:0px">{{#messages}}<li style="padding-top:5px">{{{.}}}</li>{{/messages}}</ul></span>{{/hasMessages}}</td></tr></tbody></table></div>',this._messageTmpl)}}}),Thunderhead.SF.define("ui_resize",function(e,t){"use strict";var n=function(e,n){this._el=t.document.getElementById(e),this._headerHeight=this._getAbsoluteTop(this._el),this._footerHeight=n};return e.extend(n,{DEFAULT_FOOTER_HEIGHT:85,CONSOLE_FOOTER_HEIGHT:0}),n.prototype={_el:null,_headerHeight:0,_footerHeight:0,_getAbsoluteTop:function(e){for(var t=0;e&&null!==e;)t+=e.offsetTop,e=e.offsetParent;return t},resizeElement:function(){var e=t.document.documentElement.clientHeight,n=e-this._getAbsoluteTop(this._el)-this._footerHeight;this._el.style.height=n+"px"}},n}),Thunderhead.SF.define("ui_spinner",function(){"use strict";return{html:'<img src="/img/loading.gif" width="15px" height="15px" />'}}),Thunderhead.SF.define("visualforce_remotingManager",function(e,t){"use strict";return t.Visualforce.remoting.Manager}),Thunderhead.SF.define("remoteActions",["thirdParty_underscore","thirdParty_jQuery","visualforce_remotingManager","generalSettings"],function(e,t,n,i,r,o){"use strict";function s(e){var t="Logged in?";return"parse"===e.code&&-1!==e.message.indexOf(t,e.message.length-t.length)}function a(r,a,c){return function(){var u,l=t.Deferred(),h=e(arguments).map(function(t){return e.isUndefined(t)?null:t});u=e.isFunction(e.last(h))?h.pop():function(){};var f=function(e,t){u.call(this,e,t),t.status?l.resolve(e,t):s(t)?(o.console&&o.console.error&&o.console.error("Salesforce session expired"),d.fire("session-expired")):l.reject(t)};h.push(f);var m=[i.namespace,r,a].join("."),p=[m].concat(h);c&&p.push(c);try{n.invokeAction.apply(n,p)}catch(_){l.reject(_)}return l.promise()}}var d=r.mixinObservable({sessionExpired:"session-expired"}),c={events:d,createRemoteActions:function(t,n){var i={events:d};return e.isArray(n)?e(n).reduce(function(e,n){return e[n]=a(t,n),e},i):e(n).reduce(function(e,n,i){return e[i]=a(t,i,n),e},i)}};return c}),Thunderhead.SF.define("docedt_remoteDocuments",["remoteActions"],function(e){"use strict";return e.createRemoteActions("REMOTE_CO_Documents",["getDocumentFolders","getDocumentsByFolderId","getWrappedDocuments","getDocuments"])}),Thunderhead.SF.define("docedt_emailAttachmentsDialog",["thirdParty_jQuery","thirdParty_underscore","thirdParty_mustache","ui_spinner","docedt_remoteDocuments"],function(e,t,n,i,r,o){"use strict";function s(t){return e("#"+t).html()}function a(t){e("#documents-table").empty().append("<h4>"+t.message+"</h4>")}var d=function(t,n){var i=this;o.extend(this,n),this._id=t+"_modal",e(s("doc_modal_tmpl")).appendTo(".wrap-bootstrap").attr("id",this._id),e("#th_btn_attachdocs").click(function(){r.getDocuments(i.selectedDocs).done(function(t){e("#"+i._id).modal("hide"),i.fire("SELECTED",t)}).fail(a)})};return o.mixinObservable(d.prototype),o.extend(d.prototype,{sizeLimit:null,maxDocuments:500,show:function(t){var n=this;e("#documents-table").empty(),this.selectedDocs=[],r.getDocumentFolders().pipe(function(i){n._renderFolders(i),n._showSpinner();var o=e("#"+n._id+" .th_select_folder").find(":selected").val();return r.getWrappedDocuments(o,t)}).done(function(e){n._renderDocuments(e)}).fail(a),this.selectedDocs.push.apply(this.selectedDocs,t),e("#"+this._id).modal("show")},_renderFolders:function(t){var i=n.render(s("folder-dropdown_tmpl"),{folders:t});e("#folder-list").empty().append(i);var r=this;e("#"+r._id+" .th_select_folder").change(function(){r._changeFolder()})},_renderDocuments:function(i){var r=this,o=!1;if(i.length>this.maxDocuments)return void e("#documents-table").empty().append("<h4><p>Too many documents in this folder.</p><p>The maximum is "+this.maxDocuments+". This folder contains "+i.length+" documents.</p><h4>");var a={documents:i,documentRowCls:function(){return this.Doc.Name.replace(" ","_")},date:function(){var e=new Date(this.Doc.LastModifiedDate),t=e.getDate();t=10>t?"0"+t:t;var n=e.getMonth()+1;n=10>n?"0"+n:n;var i=e.getFullYear();return t+"/"+n+"/"+i},size:function(){var e=this.Doc.BodyLength/1024;return e>=1024?(e/1024).toFixed(1)+"M":Math.ceil(e)+"K"}};if(null!==r.sizeLimit){var d=function(e){return e.Doc.BodyLength>=r.sizeLimit};o=t(i).find(d),a.isSelectable=function(){return!d(this)}}else a.isSelectable=!0;var c=n.render(s("docs-table_tmpl"),a),u=e("#documents-table").empty();o&&u.append('<p class="text-warning">Documents greater than 5MB are not supported</p>'),u.append(c),e(".document-check").each(function(t,n){var i=e(n).data("id");e(n).click(function(e){var t=e.currentTarget.checked;r._documentSelected(t,i)})})},_changeFolder:function(){var t=e("#"+this._id+" .th_select_folder").find(":selected").val(),n=this;this._currentFolderId=t,this._showSpinner(),r.getWrappedDocuments(t,this.selectedDocs).done(function(e){t===n._currentFolderId&&n._renderDocuments(e)}).fail(function(e){t===n._currentFolderId&&a(e)})},_documentSelected:function(t,n){if(t)this.selectedDocs.push(n);else{var i=e.inArray(n,this.selectedDocs);-1!==i&&this.selectedDocs.splice(i,1)}},_showSpinner:function(){e("#documents-table").empty().append(e(i.html))}}),d}),Thunderhead.SF.define("docedt_remoteDrafts",["thirdParty_jQuery","remoteActions","generalSettings","session"],function(e,t,n,i){"use strict";function r(t){return e.Deferred().reject(t).promise()}function o(t,n,o,s,l){var h=d+t+a+n,f=function(e){e.setRequestHeader("SalesforceProxy-Endpoint",h),e.setRequestHeader("Authorization"," OAuth "+i.sessionId)},m=JSON.stringify({lastmodified:o,draftxml:s,emailInfo:l});return m.length<25e5?e.ajax({type:"PUT",url:c,cache:!1,contentType:"application/json",processData:!1,dataType:"json",data:m,beforeSend:f}).pipe(function(e){return e},function(e,t,n){return{message:t+" "+n}}):r(u)}function s(e,t,n,i,r){return h(e,t,n,i,r).pipe(function(e){return e},function(s){return s.message&&-1!==s.message.toLowerCase().indexOf("input too long")?o(e,t,n,i,r):s})}var a="/attachment/",d="https://"+n.serverInstance+".salesforce.com/services/apexrest/"+n.namespace+"/draft/",c="https://"+n.namespace+"."+n.serverInstance+".visual.force.com/services/proxy",u={name:"Draft Service Error",message:"The draft that you have generated exceeds the Salesforce size limits. If the draft contains images, consider reducing the resolution or number of images in your draft, or move the images to the Template or Shared Content.",toString:function(){return this.name+": "+this.message}},l=t.createRemoteActions("REMOTE_CO_Drafts",{getDraft:{escape:!1},getDraftObject:{escape:!1},getEmailHeaderInfo:{escape:!0},reviseDraft:{escape:!0},deleteDraft:{escape:!0},saveDraft:{escape:!0}}),h=l.saveDraft;return l.saveDraft=function(e,t,n,i,a){return i.length<98e4?s(e,t,n,i,a):i.length<25e5?o(e,t,n,i,a):r(u)},l}),Thunderhead.SF.define("docgen_remoteDocbox",["remoteActions"],function(e){"use strict";return e.createRemoteActions("REMOTE_CO_Docbox",["loadDocbox"])}),Thunderhead.SF.define("remoteDocumentGenerator",["remoteActions"],function(e){"use strict";var t={escape:!1};return e.createRemoteActions("REMOTE_CO_DocumentGenerator",{generate:t,processDocumentPackage:t,finaliseDraft:t})}),Thunderhead.SF.define("documentProcessor",["thirdParty_jQuery","browser","remoteDocumentGenerator"],function(e,t,n,i,r){"use strict";var o={generationContext:null,isGenerated:function(e){var n=!1;return e&&(t.getCookie("apex__genId"+e)?n=!0:r.document.cookie="apex__genId"+e+"=1;secure"),n},getGenerationContext:function(){return o.generationContext},nextAction:function(e){e?o.generationContext=e:e=o.generationContext,o.fire(e.nextAction.toUpperCase(),e)},_createDocumentGeneratorCallback:function(e){return function(t,n){n.status?(o.generationContext=t,e.resolve(t)):e.reject(t,n)}},generate:function(t){t?o.generationContext=t:t=o.generationContext;var i=e.Deferred();return t.draftRecordId?i.resolve(t):n.generate(t.action,t.docSettingId,t.objectId,t.isServiceConsole,t.consoleTabId,o._createDocumentGeneratorCallback(i)),i.promise()},processDocumentPackage:function(){var t=e.Deferred();return n.processDocumentPackage(o.generationContext,o._createDocumentGeneratorCallback(t)),t.promise()},finaliseDraft:function(t,r){var s=e.Deferred();return s.done(function(e){o.generationContext=e,o.fire("DRAFT_FINALISED",e)}),i.extend(o.generationContext,{retainDraft:t||!1,collaborate:r||!1}),n.finaliseDraft(o.generationContext,o._createDocumentGeneratorCallback(s)),s.done(function(e){o.generationContext=e,o.nextAction(e)}),s.promise()},complete:function(){this.fire("COMPLETE",o.generationContext)},echoSign:function(){this.fire("ECHOSIGN",o.generationContext)}};return i.mixinObservable(o),o}),Thunderhead.SF.define("docgen_echosign",["browser","documentProcessor"],function(e,t){"use strict";t.on("ECHOSIGN",function(t){e.redirect(decodeURIComponent(t.echosignUrl))})}),Thunderhead.SF.define("remote_attachments",["remoteActions"],function(e){"use strict";return e.createRemoteActions("REMOTE_CO_Attachments",["getAttachments"])}),Thunderhead.SF.define("docedt_attachmentsDialog",["thirdParty_jQuery","thirdParty_underscore","thirdParty_mustache","ui_spinner","remote_attachments"],function(e,t,n,i,r,o){"use strict";function s(){}function a(t){return e("#"+t).html()}function d(e,t){return e.length>t?e.substring(0,t-3)+"...":e}var c=function(t,i,r){var s=this;this._id="attachments-dialog-"+t,this._primaryObject=i,o.extend(this,r),this._selected={},e(n.render(a("attachments-dialog_tmpl"),{primaryObject:d(i.name)})).appendTo(".wrap-bootstrap").attr("id",this._id),this._getEl("ok").click(function(){e("#"+s._id).modal("hide");var t=s._getSelectedAttachments();s.fire("SELECTED",t)})};return o.mixinObservable(c.prototype),o.extend(c.prototype,{sizeLimit:null,maxAttachments:500,show:function(){var n=this;this._getEl("attachments-table").empty(),this._selected={},this._showSpinner(),r.getAttachments(this._primaryObject.id).done(function(e){n._attachments=t(e).sortBy("CreatedDate"),n._renderAttachments()}).fail(s),e("#"+this._id).modal("show")},_renderAttachments:function(){var i=this,r=this._attachments,o=!1;if(r.length>this.maxAttachments)return this._getEl("attachments-table").empty().append("<h4><p>The Primary Object has too many attachments.</p><p>The maximum is "+this.maxAttachments+". This Object has "+r.length+" attachments.</p><h4>");var s={attachments:r,attachmentRowCls:function(){return this.Name.replace(" ","_")},date:function(){var e=new Date(this.CreatedDate),t=e.getDate();t=10>t?"0"+t:t;var n=e.getMonth()+1;n=10>n?"0"+n:n;var i=e.getFullYear();return t+"/"+n+"/"+i},size:function(){var e=this.BodyLength/1024;return e>=1024?(e/1024).toFixed(1)+"M":Math.ceil(e)+"K"}};if(null!==i.sizeLimit){var d=function(e){return e.BodyLength>=i.sizeLimit};o=t(r).find(d),s.isSelectable=function(){return!d(this)}}else s.isSelectable=!0;var c=n.render(a("attachments-dialog-table_tmpl"),s),u=this._getEl("attachments-table").empty();o&&u.append('<p class="text-warning">Attachments greater than 5MB are not supported</p>'),u.append(c),e(".attachment-check").each(function(t,n){var r=e(n).data("id");e(n).click(function(e){i._selected[r]=!!e.currentTarget.checked})})},_getSelectedAttachments:function(){return t(this._attachments).reduce(function(e,t){return this._selected[t.Id]&&e.push(t),e},[],this)},_showSpinner:function(){this._getEl("attachments-table").empty().append(e(i.html))},_getEl:function(t){return e("#"+this._id+" ."+t)}}),c}),Thunderhead.SF.define("docedt_emailDialog",["thirdParty_jQuery","thirdParty_underscore","thirdParty_mustache","fileUploader","docedt_documentModels","docedt_emailModels","docedt_attachmentsDialog","docedt_emailAttachmentsDialog"],function(e,t,n,i,r,o,s,a,d,c){"use strict";function u(t){return e("#"+t+"_tmpl").html()}var l=5242880,h=r.Document,f=o.EmailAttachment,m=function(e){this.$messages=e};t(m.prototype).extend({_show:function(t,i,r){var o=n.render(u("message"),{id:r||i,alert:i,message:t});return e(o).appendTo(this.$messages)},addWarning:function(e,t){this._show(e,"warning",t).find(".close").hide()},addError:function(e){this._show(e,"danger")},clear:function(){this.$messages.empty()},clearWarning:function(e){e?this.$messages.find(".message-"+e).remove():this.$messages.find(".message-warning").remove()}});var p=function(){this._id=0,this._current=null};t(p.prototype).extend({start:function(e){return this._id=this._id+1,this._current={name:e,id:this._id},this._current},isUploading:function(){return!!this._current},get:function(){return this._current},stop:function(){var e=this._current;return this._current=null,e}});var _=function(e,t,n){this._id="email_dialog_"+e,this._uploading=new p,this._docsToDelete={},this._inititiate(n),this.setEmail(t)};return d.mixinObservable(_.prototype),_.prototype._addUploading=function(e){this.fire("uploading",!0,e),this._uploading.start(e)},_.prototype._removeUploading=function(){var e=this._uploading.stop();return this.fire("uploading",!1,e.name),e},_.prototype.show=function(){this._renderAddresses(),this._renderAttachments(),e("#"+this._id).modal("show")},_.prototype.setEmail=function(n){var i=this;n&&n!==this._email&&(this._email&&(this._email.off(null,this),this._email.get("attachments").off(null,this)),this._email=n,this._email.get("attachments").on("change",function(){this._renderAttachments()},this),e("#"+this._id+" .from").text(i._email.get("from")),t(["to","cc","bcc","subject"]).each(function(e){i._email.on("set:"+e,function(t){i._getEmailInput(e).val(t)},i),i._getEmailInput(e).blur(function(t){i._email.set(e,t.target.value)}).val(i._email.get(e))}),n.get("toTargetObjectName")?(e("#"+this._id+" .to").hide(),e("#"+i._id+" .target-name").text(n.get("toTargetObjectName"))):e("#"+this._id+" .target").hide())},_.prototype._getEmailInput=function(t){return e("#"+this._id+" ."+t+"-input")},_.prototype._inititiate=function(r){var o=this;r=r||{};var d=r.fileUploader||{};e(n.render(u("email-modal"),{id:this._id})).appendTo(".wrap-bootstrap"),e("#"+o._id+" .close-modal").click(t.debounce(t(this._close).bind(this),1e3,!0)),this._fileUploader=new i({iframeContainerId:this._id+"_fileUploader",buttonHeight:"32px",buttonWidth:"130px",serviceId:this._id+"_service",fileObjectType:"attachment",fileSelectionCallback:t.bind(this._fileSelected,this),fileUploadedCallback:t.bind(this._fileUploaded,this),deletedCallback:t.bind(this._fileDeleted,this),storageLocation:d.storageLocation,fileDescription:d.description||""}),this._documentDialog=new a("document-dialog",{sizeLimit:l}).on("SELECTED",this._documentsSelected,this),this._attachmentsDialog=new s("attachments-dialog",r.attachments.primaryObject,{sizeLimit:l}).on("SELECTED",this._attachmentsSelected,this),t(["cc","bcc"]).each(function(t){var n=e("#"+o._id+" div."+t),i=e("#"+o._id+" a."+t);i.click(function(e){e.preventDefault(),n.toggle()})}),e("#"+this._id+" .from-salesforce").click(t.bind(function(e){e.preventDefault(),this._documentDialog.show([])},this)),e("#"+this._id+" .notes-attachments").click(t.bind(function(e){e.preventDefault(),this._attachmentsDialog.show([])},this)),this._messages=new m(e("#"+this._id+" .messages"))},_.prototype._close=function(){if(this._uploading.isUploading()){var i=this._uploading.get();this._messages.clearWarning(i.id),this._messages.addWarning(n.render(u("close-while-uploading-message"),{filename:i.name}),i.id),e("#"+this._id+" .cancel-upload").click(t.bind(function(e){e.preventDefault(),this._fileUploader.cancelUpload(),this._removeUploading(),this._forceClose()},this))}else this._forceClose()},_.prototype._forceClose=function(){e("#"+this._id).modal("hide"),this._messages.clear(),this.fire("close")},_.prototype._generateId=function(e){return this._id+"-"+e.replace(/ /gi,"_").replace(/./gi,"-")},_.prototype._renderAddresses=function(){var n,i=this;t(["cc","bcc"]).each(function(t){n=e("#"+i._id+" a."+t),i._email.get(t)?n.hide():(n.show(),e("#"+i._id+" div."+t).hide())})},_.prototype._renderAttachments=function(){var i=this,r=u("uploading"),o=n.compile(u("attachment")),s=e("#"+this._id+" .attachments").empty();
this._uploading.isUploading()&&e(r).appendTo(s),t.chain(this._email.get("attachments")).map(t.identity).reverse().each(function(t){var n=t.get("document").val();t.isSalesforceDocument()&&(n.name=n.name+"."+n.type);var r={id:i._id+"_"+n.name+"_"+n.id,document:n,attachmentUrl:c.location.origin+"/servlet/servlet.FileDownload?file="+n.id},a=e(o(r)).appendTo(s);a.data("attachment",t);var d=a.find("button.remove");t.get("isInaccessible")?d.remove():d.click(function(e){e.preventDefault(),i.removeAttachment(t)})})},_.prototype.removeAttachment=function(e){if(e.uploaded){if(!this._removingUploadedAttachment){this._removingUploadedAttachment=!0;var t=e.get("document"),n=t.get("id");this._docsToDelete[n]=t.get("name"),this._fileUploader.deleteFile(n),this._email.removeAttachment(e)}}else this._email.removeAttachment(e)},_.prototype._fileSelected=function(e){e.event.status===!0?(this._addUploading(e.params.docName),this._renderAttachments()):this._messages.addError(e.event.message)},_.prototype._fileUploaded=function(e){var t=this._removeUploading();if(this._messages.clearWarning(t.id),e.event.status===!0){var n=f.createDraftAttachment({document:new h({id:e.params.docId,name:e.params.docName})});n.uploaded=!0,this._email.addAttachment(n)}else this._renderAttachments(),this._messages.addError("Error uploading "+t.name+":<br/>"+e.event.message)},_.prototype._fileDeleted=function(e){var t,n;e.event.status!==!0?(t=e.event.details.docId,n=this._docsToDelete[t],this._messages.addError('Error deleting <a href="'+c.location.origin+"/"+t+'">'+n+"</a>:<br/>"+e.event.message)):(t=e.params.docId,n=this._docsToDelete[t],delete this._docsToDelete[t]),this._removingUploadedAttachment=!1},_.prototype._documentsSelected=function(e){var n=t(e).map(function(e){return new f({document:new h({id:e.Id,name:e.Name,type:e.Type,contentType:e.ContentType})})});this._email.get("attachments").pushAll(n)},_.prototype._attachmentsSelected=function(e){var n=t(e).map(function(e){return f.createObjectAttachment({document:new h({id:e.Id,name:e.Name})})});this._email.get("attachments").pushAll(n)},_}),Thunderhead.SF.define("visualforce_sfConsole",function(e,t){"use strict";return t.sforce.console}),Thunderhead.SF.define("docgen_docgen",["thirdParty_jQuery","visualforce_sfConsole","browser","ui_messages","generalSettings","ui_jobMessages","documentProcessor"],function(e,t,n,i,r,o,s,a,d){"use strict";function c(){e("#docgen_container .logo_container").show()}function u(){e("#docgen_container .logo_container").hide()}function l(t){t&&c(),e("#docgen_container .spinner").show()}function h(t){e("#docgen_container .spinner").hide(),t&&u()}function f(){h(!0),e(".initialise_user").empty(),e("#docgen_container .messages").empty()}function m(e){h(!1),o.getMessageTable(e.documentPackage.Messages,"#docgen_container .messages")}function p(n){c();var i='<br/><br/><div align="center">Document generation completed.</div>';e("#docgen_container .messages").html(i),t.refreshSubtabById(n,!1),d.setTimeout(function(){var e=function(e){t.closeTab(e.id)};t.getEnclosingTabId(e)},3e3)}function _(e){var t=e||s.getGenerationContext();t.isServiceConsole?(f(),p(t.consoleTabId)):n.redirect(t.redirectUrlIsUserSpecified?t.redirectUrl:t.redirectUrl?t.redirectUrl:"/"+t.objectId)}function g(){var e=s.getGenerationContext();if(null===e){var t=n.getUrlParams();e={isServiceConsole:"true"===t.console,consoleTabId:t.consoleTabId,objectId:t.objectId}}_(e)}function v(t){f();var r=s.getGenerationContext();if(null===r){var o=n.getUrlParams();r={objectId:o.objectId}}var a=r.objectId?i.buildErrorHtml(t.message)+'<div align="center"><input class="btn back-button" value="Back" type="button"/></div>':i.buildErrorHtml(t.message);e(a).appendTo("#docgen_container .messages").find(".back-button").click(g)}function b(){f(),l(!0),s.processDocumentPackage().done(function(){s.nextAction()}).fail(function(e,t){v(t)})}function y(){e(".initialise_user").empty();var t='<iframe id="user_iframe" src="'+r.dashboardAuthUrl+'" height="0px" width="0px" />';e(".initialise_user").append(t);var n="<span>Initializing for first use...</span>";e(".initialise_user").append(n),d.setTimeout(function(){b()},5e3)}function D(e){l(!0),s.generate(e).done(function(e){s.generationContext=e,"SHOW_MESSAGES"===e.nextAction?m(e):e.userNotFoundReported?y():s.nextAction(e)}).fail(function(e,t){v(t)})}s.on("COMPLETE",_);var E={init:D,returnToRecord:g,completeGeneration:_,showSpinner:l,hideSpinner:h,showLogo:c,hideLogo:u,processPackage:b,showErrors:v,closeConsoleTab:p};return E}),Thunderhead.SF.define("docedt_docedt",["thirdParty_jQuery","thirdParty_underscore","thunderhead","documentProcessor","docedt_remoteDrafts","session","generalSettings","ui_messages","ui_resize","docedt_emailModels","docedt_emailDialog","docgen_docgen","ui_jobMessages","browser"],function(e,t,n,i,r,o,s,a,d,c,u,l,h,f,m,p){"use strict";var _,g=n.DraftEditor,v=c.Email,b=function(t,n){var i=this,a="draftEditor",c="sessionid="+o.sessionIdURLEncoded+"&url="+s.partnerServerUrl+"&userid="+o.userId,u="Your session has expired. Refresh page and re-submit request. You may want to copy your changes";r.events.on("session-expired",function(){i._hideLoadingSpinner(),i._showErrorMessage(u)}),g.prototype.DRAFTEDITOR_CONTEXT="/"+s.thinstanceContext+"/draft-editor",this._draftEditorDeferred=e.Deferred();var l;l=this._draftEditor=new g({thunderheadServer:s.draftEditorServerUrl,clientServer:s.salesforceBaseUrl,clientProxyURL:s.draftEditorClientProxyUrl,targetElementID:a,extTheme:"xtheme-gray",authUrl:s.authUrl,authParams:c,loadStartupConfig:function(){return{webServiceRoot:"/"+s.thinstanceContext+"/clientServices/",titleBar:{disabled:!0},sidePanel:{width:300,open:"DataValues"}}},onReady:function(){i._draftEditorDeferred.resolve(l)}}),e("#draftEditor").css("height",0),l.setTimeout(this._draftEditorTimeout),p.setTimeout(function(){i._draftEditorDeferred.reject("The Draft Editor could not be loaded")},this._draftEditorTimeout),this._draftEditorDeferred.fail(function(){i._resizer.resizeElement()}),l.addListener("dirty",function(e){this._dirty=e},this),this._resizer=new d(a,n)};return b.prototype={_draftEditorTimeout:6e4,email:null,_resizer:null,_draftEditor:null,_draftEditorLoaded:!1,_draftEditorDeferred:null,_draftId:null,_draft:null,_afterSaveDraftXMLCB:null,_retainDraft:null,_collaborate:null,_closeDraft:null,_dirty:!1,loadDraft:function(n){this._draftId=n,f.setDraftIdHash(n);var i=t(function(e,n){return this._onDraftLoaded(e),this._loadDraftInEditor(e,n).always(t(this._onDraftLoadedInEditor).bind(this))}).bind(this),r=t(function(e){l.hideSpinner(!0),this._showErrorMessage(e)}).bind(this);return this._beforeLoading(),e.when(this._getDraft(n),this._draftEditorDeferred).then(i,r)},_getDraft:function(e){return r.getDraftObject(e).pipe(function(e){return e},function(e){return e.message})},_onDraftLoaded:function(e){e=m.extend({isEditMode:!("Finalised"===e.status||"Final"===e.status),editMode:"Finalised"===e.status||"Final"===e.status?"readOnly":"defaultMode"},e),this._draft=e,p.draft=e,l.hideSpinner(!0),this._renderDraftEditorContainer(e),this._draftEditor.setEditMode(e.editMode),e.emailInfo&&t.chain(this._handleEmailDTO).bind(this,e.emailInfo).defer(),t.chain(_.fire).bind(_,"DRAFT_LOADED",e).defer()},_loadDraftInEditor:function(t,n){var i=this,r=e.Deferred();return n.loadStringInProjectScope(t.xml,!1,s.projectId,function(e,t){e&&t?r.resolve():r.reject("The Draft failed to load."),i._afterLoaded()}),r.promise()},_hideDraftEditor:function(){e("#draftEditor").hide()},_showDraftEditor:function(){e("#draftEditor").show()},_onDraftLoadedInEditor:function(){this._draftEditorLoaded=!0,this._afterLoaded()},_renderDraftEditorContainer:function(t){var n=this;e("#draftTitle").empty(),e("#draftTitle").append(t.documentTitle),e("#reload_button").hide(),this._configureButton(t.canDelete,"delete",function(){p.confirm("Are you sure you wish to delete this draft?")&&n.deleteDraft(t)}),this._configureButton(t.canRevise,"revise",function(){n.reviseDraft()}),this._configureButton(t.isEditMode,"save",function(){n.saveDraft()}),this._configureButton(t.isEditMode,"saveclose",function(){n._closeDraft=!0,n.saveDraft()}),this._configureButton(t.canGenerate,"generate",function(){n.finaliseDraft(!1)}),this._configureButton(t.canCollaborate,"collaborate",function(){n.finaliseDraft(!1,!0)}),this._configureButton(!!t.emailInfo&&t.isEditMode,"email_properties",function(){n._draftEditor.deactivate()}),this._configureButton(!0,"reload",function(){n.reloadDraft()}),e("#draftEditorContainer").show()},_configureButton:function(t,n,i){var r=e("#th_btn_"+n);t?r.unbind("click").click(i).show():r.hide()},finaliseDraft:function(e,t){this.saveDraft(this._finaliseDraftCB,this,e,t)},loadEmail:function(){var t=this;e(".th_btn_email_properties").attr("disabled","disabled"),r.getEmailHeaderInfo(this._draftId).done(function(e){t._handleEmailDTO(e)}).fail(this._showMessageOnRemoteActionFailure("Unable to retrieve draft attachments!")).always(function(){e(".th_btn_email_properties").removeAttr("disabled")})},_showMessageOnRemoteActionFailure:function(e){var t=this;return function(){t._showErrorMessage(e)}},saveDraft:function(n,i,r,o){this._dirty=!1,this._clearErrorMessage(),e("#pageMessagePanel").hide(),this.resizeDraftEditor(),this._retainDraft=r,this._collaborate=o,this._afterSaveDraftXMLCB=n&&i?t(n).bind(i):t(function(){this._afterLoaded(),this._showSavedMessage()}).bind(this),this._beforeLoading(),this._draftEditor.getString(this._getDraftXmlCB,this)},reloadDraft:function(){e("#errorMessages").empty(),_.fire("DRAFT_RELOAD",this._draftId)},reviseDraft:function(){var e=this;r.reviseDraft(this._draftId).done(function(t){_.fire("DRAFT_REVISED",t),e.loadDraft(t)}).fail(this._showMessageOnRemoteActionFailure("Error revising draft!"))},deleteDraft:function(e){r.deleteDraft(e.id,this.getEmailDTO()).done(function(t){_.fire("DRAFT_DELETED",t,e.primaryObjectId)}).fail(this._showMessageOnRemoteActionFailure("Error deleting draft!"))},isDirty:function(){return this._dirty},resizeDraftEditor:function(){this._draftEditorLoaded&&this._resizer.resizeElement()},finaliseDraftAFCB:function(){this._afterLoaded();var t=e(".messageCell").size();0===t?(e(".finalise_progress").show(),e("#pageMessagePanel").hide(),e("#draft_container").hide(),this._hideDraftEditor()):(e("#pageMessagePanel").show(),this._showDraftEditor(),this.resizeDraftEditor())},proceedCB:function(){this._afterLoaded();var t=e(".messageCell").size();0===t?(e(".finalise_progress").show(),e("#pageMessagePanel").hide(),e("#draft_container").hide(),this._hideDraftEditor()):(e("#pageMessagePanel").show(),e("#draft_container").show(),this._showDraftEditor(),this.resizeDraftEditor())},back:function(){e(".finalise_progress").hide(),e("#pageMessagePanel").hide(),e("#draft_container").show(),e("#draftEditorContainer").show(),this._showDraftEditor(),this._afterLoaded(),this.resizeDraftEditor()},_getDraftXmlCB:function(e,t){e&&t&&0!==t.indexOf("[ERROR]")?this._persistDraft(t.replace("UTF-16","UTF-8").replace("\n","&#10;").replace("\r","&#13;")):(this._showErrorMessage("Unable to retrieve Draft XML from editor!"),this._afterLoaded())},_persistDraft:function(e){var t=this;r.saveDraft(this._draftId,this._draft.attachmentId,this._draft.lastModified,e,this.getEmailDTO()).done(function(e){t._saveDraftCB(e),t._closeDraft&&_.fire("DRAFT_CLOSE",t._draft.primaryObjectId)}).fail(function(e){var n=e.message;t._hideLoadingSpinner(),e.name&&"Draft Service Error"===e.name?t._afterLoaded():n="Unable to save draft to repository! You may want to copy your changes. "+n,t._showErrorMessage(n)})},getEmailDTO:function(){return this.email?this.email.toDTO():null},_saveDraftCB:function(t){200===t.statuscode?(this._draft.lastModified=t.lastmodified,this.loadEmail(),this._afterSaveDraftXMLCB()):(this._hideLoadingSpinner(),409===t.statuscode||403===t.statuscode?e("#reload_button").show():404!==t.statuscode&&this._showButtons(),this._showErrorMessage(t.errormessage))},_finaliseDraftCB:function(){var t=this;i.finaliseDraft(this._retainDraft,this._collaborate).done(function(n){t._hideLoadingSpinner(),t._hideDraftEditor(),e("#draftEditorContainer").hide(),l.showSpinner(!0),"SHOW_MESSAGES"===n.nextAction?(l.hideSpinner(!1),t._showJobMessage(n)):("SHOW_PDF"===n.nextAction||"COLLABORATE"===n.nextAction||"DOCUSIGN"===n.nextAction)&&l.hideSpinner(!0)}).fail(function(e,n){t._hideLoadingSpinner(),l.hideSpinner(!0),t._showErrorMessage(n.message),t._showButtons(),t.back()})},_showErrorMessage:function(t){e("#errorMessages").html(a.buildErrorHtml(t))},_showJobMessage:function(e){h.getMessageTable(e.documentPackage.Messages,"#messages")},_clearErrorMessage:function(){e("#errorMessages").html("")},_showSavedMessage:function(){this._afterLoaded(),e("#vf_container").prepend('<div id="saved_bar">Saved</div>'),e("#saved_bar").delay(2e3).slideUp()},_beforeLoading:function(){e(".drop_down_area").hide(),this._hideButtons(),this._showLoadingSpinner()},_afterLoaded:function(){this._hideLoadingSpinner(),this._showButtons(),this.resizeDraftEditor()},_hideButtons:function(){e("#draftEditorContainer .buttons").hide()},_showButtons:function(){e("#draftEditorContainer .buttons").show()},_showLoadingSpinner:function(){e("#draftEditorContainer .loading").show()},_hideLoadingSpinner:function(){e("#draftEditorContainer .loading").hide()},_handleEmailDTO:function(t){if(t){var n=this;if(this.email=v.fromDTO(t),n.emailDialog)n.emailDialog.setEmail(n.email);else{var i={fileUploader:{description:"Local attachments of draft "+n._draft.name+":"+n._draft.documentTitle,storageLocation:n._draftId},attachments:{primaryObject:{id:n._draft.primaryObjectId,name:n._draft.primaryObjectName}}};n.emailDialog=new u("email_dialog",n.email,i),n.emailDialog.on("uploading",function(e){e&&(n._dirty=!0)},n),n.emailDialog.on("close",function(){n._draftEditor.activate()},n)}e(".th_btn_email_properties").click(function(e){e.preventDefault(),n.emailDialog.show()})}}},_={_draftEditorController:null,init:function(t,n){var i;i=_._draftEditorController=new b(t,n),m.extend(p,{back:function(){i.back()},onbeforeunload:function(){return i.isDirty()?"You will lose all your changes, are you sure you want to leave this page?":void 0}}),p.onresize=function(){i.resizeDraftEditor()},e(".email_subject").keypress(function(){e(this).val().length>100&&e(this).val(e(this).val().substr(0,100))}),e(".email_addresses").keypress(function(){e(this).val().length>2e3&&e(this).val(e(this).val().substr(0,2e3))})},loadDraft:function(e){_._draftEditorController.loadDraft(e)},show:function(){_._draftEditorController._showButtons(),_._draftEditorController.back()}},m.mixinObservable(_)}),Thunderhead.SF.define("docedt_chatterDropdown",["thirdParty_jQuery","thirdParty_mustache","generalSettings","ui_dropdown","docedt_docedt"],function(e,t,n,i,r){"use strict";return{init:function(o,s,a){var d=e(t.render(e("#chatter-dropdown-area_tmpl").html(),{id:s}));e("#"+s).replaceWith(d),i(o,d,"chatter-menu-button",a),r.on("DRAFT_LOADED",function(t){if(!t.isEditMode)return void e("#"+o).hide();var i="/apex/"+n.orgNamespace+"CHATTR_Post?draftRecordId="+t.id+"&attachmentId="+t.attachmentId+"&docSettingId="+t.docSettingId+"&objectId="+t.primaryObjectId,r="/apex/"+n.orgNamespace+"CHATTR_Feed?recordId="+t.id;e("#post-tab_"+s+" iframe").attr("src",i),d.find(".tab_content").hide();var a=d.find(".active_tab").attr("href");e(a).show(),d.find(".tab").click(function(){d.find(".tab").removeClass("active_tab"),e(this).addClass("active_tab");var t=e(this).attr("href");d.find(".tab_content").hide(),e(t).show();var n=e(t+" iframe").attr("src");n||0!==t.indexOf("#frame-tab")||(e(t+" iframe").attr("src",r),e(t+" iframe").attr("style","width:0px;height:0px;"),e(t+" img").show())}),e("#"+o).show()})}}}),Thunderhead.SF.define("docgen_collaborate",["thirdParty_jQuery","visualforce_sfConsole","browser","session","generalSettings","ui_messages","docgen_docgen","docgen_remoteDocbox","documentProcessor","ui_resize"],function(e,t,n,i,r,o,s,a,d,c,u,l){"use strict";function h(){if(!_){var e=g||"false"===n.getUrlParams().showHeader;_=new c("collab_iframe",e?c.CONSOLE_FOOTER_HEIGHT:c.DEFAULT_FOOTER_HEIGHT)}return _}function f(i,r){s.hideSpinner(!0),e("#collab_messages").hide(),g&&(t.setTabTitle(r),t.setTabLink());var o=i+"&sessionid="+v+"&url="+n.urlEncode(y)+"&userid="+b,a='<iframe id="collab_iframe" src="'+o+'" width="100%" style="border: none"/>';e("#collab_container").empty().append(a),_=h(),_.resizeElement()}function m(t){s.hideSpinner(!0),e(o.buildErrorHtml(t.message)).appendTo("#collab_messages")}function p(t){s.showSpinner(!0),n.setDocboxIdHash(t.docboxId),t.collaborateDocboxUrl?(g=t.isServiceConsole,f(t.collaborateDocboxUrl,t.consoleTabTitle)):a.loadDocbox(t.docboxId).done(function(t){e("#collab_messages").hide(),f(t,"")}).fail(function(t){e("#collab_container").hide(),m(t)})}var _,g,v=i.sessionIdURLEncoded,b=i.userId,y=r.partnerServerUrl;e(function(){d.on("COLLABORATE",p,this)}),e(l).resize(function(){e("#collab_iframe").is(":visible")&&(_=h(),_.resizeElement())})}),Thunderhead.SF.define("docgen_docusign",["thirdParty_jQuery","visualforce_sfConsole","documentProcessor","docgen_docgen","ui_resize"],function(e,t,n,i,r,o,s){"use strict";function a(){return c||(c=new r("ds_iframe",r.DEFAULT_FOOTER_HEIGHT)),c}function d(t){i.hideSpinner(!0);var n=decodeURIComponent(t.docusignUrl),r='<iframe id="ds_iframe" src="'+n+'" width="100%" style="border: none"/>';e("#ds_container").empty().append(r),c=a(),c.resizeElement()}var c;e(s).resize(function(){e("#ds_iframe").is(":visible")&&(c=a(),c.resizeElement())}),n.on("DOCUSIGN",d,this)}),Thunderhead.SF.define("docgen_preview",["thirdParty_jQuery","thirdParty_underscore","visualforce_sfConsole","browser","session","generalSettings","documentProcessor","docgen_docgen","ui_resize"],function(e,t,n,i,r,o,s,a,d,c,u){"use strict";function l(){C=!1,s.complete()}function h(){C=!1,s.echoSign()}function f(t){t.showESign?(e("#th_btn_finish_primary").hide(),e("#th_btn_finish_secondary").click(l),e("#th_btn_esign").click(h)):(e("#th_btn_finish_primary").click(l),e("#th_btn_finish_secondary").hide(),e("#th_btn_esign").hide())}function m(e){return S+i.urlEncode(e)}function p(e){var t=e+"&sessionid="+E+"&url="+w+"&userid="+T;u.document.getElementById("th_iframe_pdfviewer").src=t}function _(e,t,n){return function(){p(e),n.setText(t);var i=u.document.getElementById("titleText");i.innerHTML=t}}function g(i){var r=i.MasterDocument,o=i.Enclosures||[],s=t([r].concat(o)).map(function(e){return{location:m(e.Location),name:e.DocumentName}}),a=u.document.getElementById("titleText");a.innerHTML=s[0].name,n.isInConsole()&&n.setTabTitle(a.innerHTML);var d;if(o.length>0){d=u.Ext.create("Ext.button.Split",{renderTo:"documentListDropdown",text:s[0].name,id:"doc-list-btn",handler:function(e,t){this.showMenu(t)},height:27,border:!1,hidden:!0,ui:"tertiary",menu:new u.Ext.menu.Menu({plain:!0,shadow:!1,border:!1,bodyBorder:!1,margin:"5 5 5 5",id:"doc-menu-btn",ui:"tertiary",showSeparator:!1})});var c,l=d.menu;for(c=0;c<s.length;c+=1)l.add({activeCls:"docItemActiveClass",border:!1,text:s[c].name,handler:_(s[c].location,s[c].name,d)});d.setVisible(!0);var h;d.addListener("menushow",function(){e.browser.msie&&(void 0===h?(h=l.getEl().createShim(),h.setBox(l.getEl().getBox()),h.setStyle("z-index","1"),h.setLeftTop(d.getPosition()[0],d.getPosition()[1]+5+d.getHeight())):(h.setLeft(d.getPosition()[0]),h.setDisplayed(!0)))}),d.addListener("menuhide",function(){e.browser.msie&&void 0!==h&&h.setDisplayed(!1)}),e("#doclistspan").show()}else e("#doclistspan").hide()}function v(){return C?"You will not be able to return to this document!":void 0}function b(t){e("#show_pdf").show();var n=new d("pdfViewer",t?d.CONSOLE_FOOTER_HEIGHT:d.DEFAULT_FOOTER_HEIGHT);n.resizeElement(),u.onresize=function(){n.resizeElement()}}function y(t,n){var r=n.MasterDocument,o=m(r.Location);u.onbeforeunload=v;var s=o+"&sessionid="+E+"&url="+i.urlEncode(w)+"&userid="+T;u.loadPDFViewer=function(){b()};var a='<iframe src="'+s+'" frameborder="0" height="100%" id="th_iframe_pdfviewer" name="th_iframe_pdfviewer" scrolling="no" title="Content" width="100%" html-onload="loadPDFViewer();"></iframe>';e("#pdfViewer").empty().append(a),b(t.isServiceConsole)}function D(e){a.hideSpinner(!0);var t=e.documentPackage.Envelopes[0];f(e),g(t),y(e,t)}var E=r.sessionIdURLEncoded,T=r.userId,w=o.partnerServerUrl,S=o.salesforceServicesUrl,C=!0;s.on("SHOW_PDF",D,this)});